// https://github.com/Euphrasiologist/guitarneck#readme v1.0.1 Copyright 2021 Max Brown
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@tonaljs/tonal"),require("d3")):"function"==typeof define&&define.amd?define(["@tonaljs/tonal","d3"],e):(t=t||self).guitarneck=e(t.tonal,t.d3)}(this,(function(t,e){"use strict";return class{constructor(i){this.parent=i,this.totalWidth=1024,this.totalHeight=Math.max(this.totalWidth/6,300),this.margin={top:120,right:10,left:30,bottom:30},this.tuning=["E4","B3","G3","D3","A2","E2"],this.parsedTuning=this.tuning.map(t.Note.get),this.numStrings=this.tuning.length,this.minFret=0,this.maxFret=Math.round(this.totalWidth/48),this.placements=null,this.scale=null,this.tooltip=e.select("body").append("div").attr("class","svg-tooltip").attr("class","tiplabs").style("font-family","sans-serif").style("position","absolute").style("text-align","center").style("visibility","hidden").style("border-style","solid").style("border-color","black").style("background-color","white").style("list-style","none").style("width","20px")}size(t,e){return this.totalWidth=t,this.totalHeight=e,this}getNotes(e){let i=[];for(let s=0;s<6;s++){let a=e.split(" ")[0]+s+" "+e.split(" ").slice(1,e.split(" ").length).join(" "),l=t.Scale.scale(a).notes;i.push(l)}return i.flat()}placeNote(e){const i=t.Note.get(e);return this.parsedTuning.map(t=>i.height-t.height).map((t,e)=>t>=this.minFret&&t<=this.maxFret?{note:i,fret:t,string:e+1}:null).filter(Boolean)}addScale(t){this.scale=t,this.placements=this.getNotes(t).map(t=>this.placeNote(t)).flat()}drawFretBoard(){const t=e.scaleLinear().domain([1,this.numStrings]).range([this.margin.top,this.totalHeight-this.margin.bottom]),i=e.scaleLinear().domain([this.minFret,this.maxFret]).range([this.margin.left,this.totalWidth-this.margin.right]),s=this.parent.append("g");s.selectAll(".string").data(e.range(1,this.numStrings+1)).join("line").attr("class","string").attr("stroke","black").attr("x1",i(this.minFret)).attr("x2",i(this.maxFret)).attr("y1",e=>t(e)).attr("y2",e=>t(e)).attr("stroke-width",3),s.selectAll(".fret").data(e.range(this.minFret,this.maxFret+1)).join("line").attr("class","fret").attr("stroke","black").attr("y1",t(1)-.5).attr("y2",t(this.numStrings)+.5).attr("x1",t=>i(t)).attr("x2",t=>i(t)).attr("stroke-width",t=>0===t?5:3);const a=this.parent.append("g");a.append("g").attr("transform",`translate(${this.margin.left-10}, -0.5)`).style("font-size","20px").call(e.axisLeft().scale(t).ticks(this.numStrings).tickSize(0)).call(t=>t.select(".domain").remove()),a.append("g").attr("transform",`translate(${-i.range()[1]/this.maxFret/2}, ${this.totalHeight-this.margin.bottom+12})`).style("font-size","10px").call(e.axisBottom().scale(i).ticks(this.maxFret-this.minFret).tickSize(0).tickFormat(t=>t>0?t:"")).call(t=>t.select(".domain").remove());const l=this.parent.append("g"),n=this.tooltip;l.selectAll("placement").data(this.placements).join("circle").attr("class","placement").attr("id",t=>t.note.pc).attr("cx",t=>i(t.fret-.5)).attr("cy",e=>t(e.string)).attr("fill","black").attr("stroke","black").attr("stroke-width",2).attr("r",t=>t.fret-.5<0?0:8).on("pointerenter",(function(t,e){l.selectAll("#"+e.note.pc).attr("fill","orange"),n.style("visibility","visible")})).on("pointermove",(function(t,e){l.selectAll("#"+e.note.pc).attr("fill","orange"),n.style("top",t.pageY-10+"px").style("left",t.pageX+10+"px").style("color","black").style("font-style","normal").html(""+e.note.pc).style("font-family","sans-serif")})).on("pointerleave",(function(t,e){l.selectAll("#"+e.note.pc).attr("fill","black"),n.style("visibility","hidden")}))}addHTML(){this.parent.append("g").append("foreignObject").attr("width",this.totalWidth/2).attr("height",this.margin.top).append("xhtml:div").attr("class","textbox").style("font","19px 'Helvetica Neue'").html(`<h1>Scale: ${this.scale}</h1><p>Containing the notes: ${Array.from(new Set(this.placements.map(t=>t.note.pc))).map(t=>" "+t)}</p>`)}render(t){return this.addScale(t),this.drawFretBoard(),this.addHTML(),this}}}));
